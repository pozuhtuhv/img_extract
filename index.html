<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>HTML IMG SRC 추출 → 스택 코드 생성</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 180px; margin-bottom: 10px; }
    button { padding: 10px 16px; margin: 4px 8px 8px 0; cursor: pointer; }
    label { display:inline-flex; align-items:center; gap:8px; margin: 0 16px 8px 0; }
    .code-box {
      background:#f6f6f6; border:1px solid #ccc; padding:10px;
      white-space:pre-wrap; word-break:break-all; margin: 12px 0 16px 0;
    }
    .meta { font-size:12px; color:#666; margin: 4px 0 8px 2px; }

    /* 미리보기: 페이지 맨 아래 */
    .stack-preview {
      text-align:center; max-width:1000px; margin: 16px auto 0;
      line-height:0; font-size:0;
    }
    .stack-preview img {
      width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;
    }

    /* YouTube 미리보기: 기본 보임, 세로 스택(block) */
    .yt-stack {
      max-width: 1000px;
      margin: 8px auto 0;
    }
    .yt-box {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      display: block;              /* grid 대신 block */
      margin: 0 0 12px 0;          /* 세로 스택 간격 */
    }
    .yt-box iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
  </style>
</head>
<body>
  <h2>HTML IMG SRC 추출 → 스택 코드 생성</h2>

  <textarea id="htmlInput" placeholder="HTML 또는 이미지 URL 텍스트(공백/줄바꿈으로 나열) 를 붙여넣으세요."></textarea><br/>

  <!-- 옵션: 출력 시 <img> style 제거 -->
  <div style="margin: 6px 0 10px 0;">
    <label>
      <input type="checkbox" id="stripStyle" />
      무신사용 (출력 코드에서 &lt;img&gt;의 style 속성 제거)
    </label>
  </div>

  <button onclick="run()">추출 & 코드생성</button>
  <button onclick="copyCode()">코드 복사</button>

  <!-- 추출 개수 표시 -->
  <div id="countInfo" class="meta"></div>

  <!-- 복사용 코드 출력 (위) -->
  <div id="codeOutput" class="code-box"></div>

  <!-- 미리보기 (맨 아래) -->
  <div id="preview"></div>

<script>
function run() {
  const raw = document.getElementById('htmlInput').value || '';
  const stripStyles = document.getElementById('stripStyle').checked;

  // HTML 파싱
  const parser = new DOMParser();
  const doc = parser.parseFromString(raw, 'text/html');

  // 1) <img> 태그에서 src 추출 (HTML 모드)
  let urls = Array.from(doc.querySelectorAll('img[src]'))
    .map(el => el.getAttribute('src'))
    .filter(Boolean);

  // 1-1) (텍스트 모드) <img>가 하나도 없으면 자유 텍스트에서 이미지 URL 추출
  if (urls.length === 0) {
    const imageUrlRegex = /(https?:\/\/[^\s"'<>]+?\.(?:png|jpe?g|gif|webp|svg)(?:\?[^\s"'<>]*)?)/gi;
    urls = (raw.match(imageUrlRegex) || [])
      .map(u => u.replace(/^[\s"'(\[]+|[)\]\s"',.;!?]+$/g, ''))
      .filter(Boolean);
  }

  // 중복 제거(순서 유지)
  const seen = new Set();
  urls = urls.filter(u => (seen.has(u) ? false : (seen.add(u), true)));

  // 2) YouTube iframe 원문 + src 추출 (HTML에 있을 때만)
  const youtubeEls = Array.from(doc.querySelectorAll('iframe[src]'))
    .filter(el => /(?:youtube\.com|youtu\.be)/i.test(el.getAttribute('src') || ''));
  const youtubeRawBlocks = youtubeEls.map(el => `<div style="display:flex; justify-content:center;">${el.outerHTML.trim()}</div>`);
  const youtubeSrcs = youtubeEls.map(el => el.getAttribute('src'));

  const codeBox = document.getElementById('codeOutput');
  const preview = document.getElementById('preview');
  const countInfo = document.getElementById('countInfo');

  if (urls.length === 0 && youtubeEls.length === 0) {
    codeBox.textContent = '';
    preview.innerHTML = "<p style='color:#d00'>img 또는 유튜브 iframe을 찾지 못했습니다.</p>";
    countInfo.textContent = '';
    return;
  }

  // 3) 이미지 스택 HTML 생성
  const openDiv = '<div style="text-align:center; max-width:100%; margin:0 auto; line-height:0; font-size:0;">';
  const imgTagForOutput = (u) =>
    stripStyles
      ? `<img src="${u}">`
      : `<img src="${u}" style="width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;">`;
  const imgTagForPreview = (u) =>
      `<img src="${u}" style="width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;">`;

  const closeDiv = '</div>';

  // 출력용(복사할 코드) : (iframe들) + (이미지 스택)
  const stackHtmlOutput = urls.length ? openDiv + urls.map(imgTagForOutput).join('') + closeDiv : '';
  const finalHtml = [youtubeRawBlocks.join('\n'), stackHtmlOutput].filter(Boolean).join('\n');

  // 4) 복사용 코드 출력
  codeBox.textContent = finalHtml;

  // 5) 미리보기 구성
  // 5-1) 유튜브 미리보기 (항상 보임, block 스택)
  let ytPreview = '';
  if (youtubeSrcs.length) {
    const ytBoxes = youtubeSrcs.map(src => {
      const hasQ = src.includes('?');
      const safeSrc = src + (src.includes('rel=0') ? '' : (hasQ ? '&rel=0' : '?rel=0'));
      return `<div class="yt-box"><iframe src="${safeSrc}" loading="lazy" allowfullscreen></iframe></div>`;
    }).join('');
    ytPreview = `<div class="yt-stack">${ytBoxes}</div>`;
  }

  // 5-2) 이미지 미리보기 (유튜브 아래가 아니라, 유튜브 '아래'가 아닌 '뒤'가 되게? — 요구사항: 유튜브가 위, 이미지가 아래)
  const previewStack = urls.length ? `<div class="stack-preview">${urls.map(imgTagForPreview).join('')}</div>` : '';

  // 6) 미리보기 출력: 유튜브 위, 그 다음 이미지
  preview.innerHTML = [ytPreview, previewStack].filter(Boolean).join('');

  // 7) 개수 표기 - 작게
  const totalLinks = urls.length + youtubeSrcs.length;
  countInfo.textContent = `이미지 ${urls.length}개${youtubeSrcs.length ? `, 유튜브 ${youtubeSrcs.length}개` : ''} (총 ${totalLinks}개)`;
}

function copyCode() {
  const code = document.getElementById('codeOutput').textContent.trim();
  if (!code) { alert('복사할 코드가 없습니다. 먼저 추출을 실행하세요.'); return; }
  navigator.clipboard.writeText(code).then(() => alert('코드가 복사되었습니다.'));
}
</script>

</body>
</html>
