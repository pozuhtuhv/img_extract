<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>HTML IMG SRC 추출 → 스택 코드 생성</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 180px; margin-bottom: 10px; }
    button { padding: 10px 16px; margin: 4px 8px 8px 0; cursor: pointer; }
    label { display:inline-flex; align-items:center; gap:8px; margin: 0 16px 8px 0; }
    .code-box {
      background:#f6f6f6; border:1px solid #ccc; padding:10px;
      white-space:pre-wrap; word-break:break-all; margin: 12px 0 16px 0;
    }
    .meta { font-size:12px; color:#666; margin: 4px 0 8px 2px; }

    /* 미리보기: 페이지 맨 아래 */
    .stack-preview {
      text-align:center; max-width:1000px; margin: 16px auto 0;
      line-height:0; font-size:0;
    }
    .stack-preview img {
      width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;
    }

    /* YouTube 미리보기: 기본 보임, 세로 스택(block) */
    .yt-stack {
      max-width: 1000px;
      margin: 8px auto 0;
    }
    .yt-box {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      display: block;              /* grid 대신 block */
      margin: 0 0 12px 0;          /* 세로 스택 간격 */
    }
    .yt-box iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
  </style>
</head>
<body>
  <h2>HTML IMG SRC 추출 → 스택 코드 생성</h2>

  <textarea id="htmlInput" placeholder="HTML 또는 이미지 URL 텍스트(공백/줄바꿈으로 나열) 를 붙여넣으세요."></textarea><br/>

  <!-- 옵션: 출력 시 <img> style 제거 -->
  <div style="margin: 6px 0 10px 0;">
    <label>
      <input type="checkbox" id="stripStyle" />
      무신사용 (출력 코드에서 &lt;img&gt;의 style 속성 제거)
    </label>
  </div>

  <button onclick="run()">추출 & 코드생성</button>
  <button onclick="copyCode()">코드 복사</button>

  <!-- 추출 개수 표시 -->
  <div id="countInfo" class="meta"></div>

  <!-- 복사용 코드 출력 (위) -->
  <div id="codeOutput" class="code-box"></div>

  <!-- 미리보기 (맨 아래) -->
  <div id="preview"></div>

<script>
function run() {
  const raw = document.getElementById('htmlInput').value || '';
  const stripStyles = document.getElementById('stripStyle').checked;

  const parser = new DOMParser();
  const doc = parser.parseFromString(raw, 'text/html');

  // 1) 이미지 URL 추출
  let urls = Array.from(doc.querySelectorAll('img[src]'))
    .map(el => el.getAttribute('src'))
    .filter(Boolean);
  if (urls.length === 0) {
    const imageUrlRegex = /(https?:\/\/[^\s"'<>]+?\.(?:png|jpe?g|gif|webp|svg)(?:\?[^\s"'<>]*)?)/gi;
    urls = (raw.match(imageUrlRegex) || [])
      .map(u => u.replace(/^[\s"'(\[]+|[)\]\s"',.;!?]+$/g, ''))
      .filter(Boolean);
  }
  const seen = new Set();
  urls = urls.filter(u => (seen.has(u) ? false : (seen.add(u), true)));

  // 2) YouTube → 요청하신 래퍼 형태로 변환
  const youtubeEls = Array.from(doc.querySelectorAll('iframe[src]'))
    .filter(el => /(?:youtube\.com|youtu\.be)/i.test(el.getAttribute('src') || ''));

  const buildYouTubeWrapperFromSrc = (src) => {
    let base = (src || '').trim();
    // watch / youtu.be → embed 정규화 + videoId 추출
    let videoId = '';
    const mWatch = base.match(/[?&]v=([^&]+)/);
    const mShort = base.match(/youtu\.be\/([^?&]+)/);
    const mEmbed = base.match(/\/embed\/([^?&/]+)/);

    if (/youtube\.com\/watch/.test(base) && mWatch) {
      videoId = mWatch[1];
      base = `https://www.youtube.com/embed/${videoId}`;
    } else if (/youtu\.be\//.test(base) && mShort) {
      videoId = mShort[1];
      base = `https://www.youtube.com/embed/${videoId}`;
    } else if (mEmbed) {
      videoId = mEmbed[1];
    }

    const hasQ = base.includes('?');
    let finalSrc = base + (hasQ ? '&' : '?') + 'controls=0&autoplay=1&mute=1&controls=0&loop=1';
    if (videoId && !/[\?&]playlist=/.test(finalSrc)) {
      finalSrc += `&playlist=${videoId}`;
    }

    return `
<div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; margin-bottom: 30px;">
  <iframe src="${finalSrc}" title="YouTube video player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen=""
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
</div>`.trim();
  };

  const youtubeBlocks = youtubeEls.map(el => buildYouTubeWrapperFromSrc(el.getAttribute('src')));

  const codeBox = document.getElementById('codeOutput');
  const preview = document.getElementById('preview');
  const countInfo = document.getElementById('countInfo');

  if (urls.length === 0 && youtubeBlocks.length === 0) {
    codeBox.textContent = '';
    preview.innerHTML = "<p style='color:#d00'>img 또는 유튜브 iframe을 찾지 못했습니다.</p>";
    countInfo.textContent = '';
    return;
  }

  // 3) 이미지 스택 HTML 생성
  const openDiv = '<div style="text-align:center; max-width:100%; margin:0 auto; line-height:0; font-size:0;">';
  const imgTagForOutput = (u) =>
    stripStyles ? `<img src="${u}">`
                : `<img src="${u}" style="width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;">`;
  const imgTagForPreview = (u) =>
      `<img src="${u}" style="width:100%; height:auto; display:block; margin:0; padding:0; border:0; vertical-align:top;">`;
  const closeDiv = '</div>';

  const stackHtmlOutput = urls.length ? openDiv + urls.map(imgTagForOutput).join('') + closeDiv : '';

  // 4) 복사용 코드 출력: 유튜브(요청 포맷) + 이미지 스택
  const finalHtml = [youtubeBlocks.join('\n'), stackHtmlOutput].filter(Boolean).join('\n');
  codeBox.textContent = finalHtml;

  // 5) 미리보기: 유튜브(동일 포맷) + 이미지
  const ytPreview = youtubeBlocks.join('');
  const previewStack = urls.length ? `<div class="stack-preview">${urls.map(imgTagForPreview).join('')}</div>` : '';
  preview.innerHTML = [ytPreview, previewStack].filter(Boolean).join('');

  // 6) 개수 표기
  const totalLinks = urls.length + youtubeBlocks.length;
  countInfo.textContent = `이미지 ${urls.length}개${youtubeBlocks.length ? `, 유튜브 ${youtubeBlocks.length}개` : ''} (총 ${totalLinks}개)`;
}

function copyCode() {
  const code = document.getElementById('codeOutput').textContent.trim();
  if (!code) { alert('복사할 코드가 없습니다. 먼저 추출을 실행하세요.'); return; }
  navigator.clipboard.writeText(code).then(() => alert('코드가 복사되었습니다.'));
}
</script>

</body>
</html>
